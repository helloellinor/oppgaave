<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHD Task Manager</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ðŸ§  ADHD Task Manager</h1>
            <div class="current-time">{{.CurrentTime}}</div>
        </header>

        <main class="main-content">
            <div class="budget-section">
                <div id="budget-widget" hx-get="/budget-widget" hx-trigger="load, every 30s">
                    {{template "budget_widget.html" .Budget}}
                </div>
            </div>

            <!-- Radar View Section -->
            <div class="radar-section">
                <div class="section-header">
                    <h2>ðŸŽ¯ Task Radar</h2>
                    <div class="view-toggles">
                        <button class="btn btn-secondary active" id="radar-btn">
                            ðŸŽ¯ Radar View
                        </button>
                        <button class="btn btn-secondary" id="list-btn">
                            ðŸ“‹ List View
                        </button>
                    </div>
                </div>
                
                <div id="main-task-view">
                    <!-- Show radar view by default -->
                    <div class="radar-container">
                        <div class="radar-screen">
                            <div class="radar-grid">
                                <!-- Concentric circles for time -->
                                <div class="radar-circle radar-circle-1"></div>
                                <div class="radar-circle radar-circle-2"></div>
                                <div class="radar-circle radar-circle-3"></div>
                                <div class="radar-circle radar-circle-4"></div>
                                
                                <!-- Cross lines for quadrants -->
                                <div class="radar-line radar-line-horizontal"></div>
                                <div class="radar-line radar-line-vertical"></div>
                                
                                <!-- Time labels -->
                                <div class="radar-label radar-label-top">High Priority/Energy</div>
                                <div class="radar-label radar-label-right">1 Week</div>
                                <div class="radar-label radar-label-bottom">Low Priority/Energy</div>
                                <div class="radar-label radar-label-left">Now</div>
                                <div class="radar-label radar-label-center">Task Radar</div>
                            </div>
                            
                            <!-- Tasks as radar blips -->
                            {{range .Tasks}}
                                <div class="radar-blip radar-blip-{{.TaskType}} {{.GetUrgencyColor}} {{if .IsBlocked}}blocked{{end}}"
                                     style="left: {{.RadarPositionX}}%; bottom: {{.RadarPositionY}}%;"
                                     data-task-id="{{.ID}}"
                                     onclick="showTaskDetails({{.ID}})">
                                    <div class="radar-blip-icon">{{.GetTaskTypeIcon}}</div>
                                    <div class="radar-blip-title">{{.Title}}</div>
                                    {{if .IsEvent}}
                                        <div class="radar-blip-time">
                                            {{if .EventStart}}{{formatTime .EventStart}}{{end}}
                                        </div>
                                    {{end}}
                                    {{if .Contacts}}
                                        <div class="radar-blip-contacts">
                                            {{range .Contacts}}ðŸ‘¤{{end}}
                                        </div>
                                    {{end}}
                                </div>
                            {{end}}
                            
                            <!-- Radar sweep animation -->
                            <div class="radar-sweep"></div>
                        </div>
                        
                        <!-- Timeline at bottom -->
                        <div class="radar-timeline">
                            <div class="timeline-marker timeline-now">Now</div>
                            <div class="timeline-marker timeline-today">Today</div>
                            <div class="timeline-marker timeline-tomorrow">Tomorrow</div>
                            <div class="timeline-marker timeline-week">This Week</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <section class="today-tasks">
                    <h2>ðŸ“… Today's Focus</h2>
                    <div class="task-timeline">
                        {{range .TodayTasks}}
                            {{template "task_item.html" .}}
                        {{end}}
                    </div>
                </section>

                <section class="contacts-section">
                    <div id="contacts-container" hx-get="/contacts" hx-trigger="load">
                        <!-- Contact list will be loaded here -->
                    </div>
                </section>
            </div>

            <div class="task-management-section">
                <div class="section-header">
                    <h2>ðŸ“‹ All Tasks</h2>
                    <button 
                        class="btn btn-primary"
                        hx-get="/tasks/create"
                        hx-target="#create-task-modal"
                        hx-trigger="click">
                        âž• Add Task
                    </button>
                </div>
                
                <div id="task-list" hx-get="/tasks" hx-trigger="load">
                    {{range .Tasks}}
                        {{template "task_item.html" .}}
                    {{end}}
                </div>
            </div>
        </main>

        <!-- Modal for creating tasks -->
        <div id="create-task-modal" class="modal"></div>
    </div>

    <script>
        // Simple JavaScript for radar/list view toggle and basic interactions
        
        // Task detail modal functionality
        function showTaskDetails(taskId) {
            // For demo purposes, show an alert with task info
            fetch(`/tasks/${taskId}/details`)
                .then(response => response.text())
                .then(html => {
                    const modal = document.createElement('div');
                    modal.id = 'task-details-modal';
                    modal.className = 'modal';
                    modal.innerHTML = html;
                    document.body.appendChild(modal);
                    
                    // Close modal when clicking outside
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                })
                .catch(err => console.error('Error loading task details:', err));
        }
        
        // View toggle functionality (simplified without HTMX)
        document.addEventListener('DOMContentLoaded', function() {
            const radarBtn = document.getElementById('radar-btn');
            const listBtn = document.getElementById('list-btn');
            const mainView = document.getElementById('main-task-view');
            
            if (radarBtn && listBtn) {
                radarBtn.addEventListener('click', function() {
                    radarBtn.classList.add('active');
                    listBtn.classList.remove('active');
                    // Radar view is already loaded by default
                });
                
                listBtn.addEventListener('click', function() {
                    listBtn.classList.add('active');
                    radarBtn.classList.remove('active');
                    
                    // Load list view
                    fetch('/tasks')
                        .then(response => response.text())
                        .then(html => {
                            mainView.innerHTML = html;
                        })
                        .catch(err => console.error('Error loading list view:', err));
                });
            }
        });
        
        // Auto-refresh functionality (simplified)
        setInterval(function() {
            // Refresh budget widget
            fetch('/budget-widget')
                .then(response => response.text())
                .then(html => {
                    const budgetWidget = document.getElementById('budget-widget');
                    if (budgetWidget) {
                        budgetWidget.innerHTML = html;
                    }
                })
                .catch(err => console.error('Error refreshing budget:', err));
        }, 30000); // Every 30 seconds
    </script>
</body>
</html>